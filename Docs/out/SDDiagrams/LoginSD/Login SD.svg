<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1529px" preserveAspectRatio="none" style="width:1317px;height:1529px;background:#FFFFFF;" version="1.1" viewBox="0 0 1317 1529" width="1317px" zoomAndPan="magnify"><defs/><g><rect fill="none" height="79.0547" style="stroke:#FF0000;stroke-width:1.0;" width="506" x="20" y="221.0156"/><rect fill="none" height="79.0547" style="stroke:#FF0000;stroke-width:1.0;" width="506" x="20" y="374.7734"/><rect fill="none" height="79.0547" style="stroke:#FF0000;stroke-width:1.0;" width="506" x="20" y="467.8281"/><rect fill="none" height="79.0547" style="stroke:#FF0000;stroke-width:1.0;" width="506" x="20" y="560.8828"/><rect fill="none" height="79.0547" style="stroke:#FF0000;stroke-width:1.0;" width="506" x="20" y="727.6406"/><rect fill="none" height="427.9219" style="stroke:#FF0000;stroke-width:1.0;" width="1301.5" x="10" y="881.3984"/><rect fill="none" height="79.0547" style="stroke:#FF0000;stroke-width:1.0;" width="506" x="20" y="1101.8594"/><line style="stroke:#0000FF;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="47" x2="47" y1="82.6094" y2="1447.7266"/><line style="stroke:#0000FF;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="208" x2="208" y1="82.6094" y2="1447.7266"/><line style="stroke:#0000FF;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="466" x2="466" y1="82.6094" y2="1447.7266"/><line style="stroke:#0000FF;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="767.5" x2="767.5" y1="82.6094" y2="1447.7266"/><line style="stroke:#0000FF;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="880.5" x2="880.5" y1="82.6094" y2="1447.7266"/><line style="stroke:#0000FF;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1021.5" x2="1021.5" y1="82.6094" y2="1447.7266"/><line style="stroke:#0000FF;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1140.5" x2="1140.5" y1="82.6094" y2="1447.7266"/><line style="stroke:#0000FF;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1242.5" x2="1242.5" y1="82.6094" y2="1447.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="29" x="30" y="79.5332">User</text><ellipse cx="47.5" cy="13.5" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M47.5,21.5 L47.5,48.5 M34.5,29.5 L60.5,29.5 M47.5,48.5 L34.5,63.5 M47.5,48.5 L60.5,63.5 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="29" x="30" y="1461.2598">User</text><ellipse cx="47.5" cy="1472.8359" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M47.5,1480.8359 L47.5,1507.8359 M34.5,1488.8359 L60.5,1488.8359 M47.5,1507.8359 L34.5,1522.8359 M47.5,1507.8359 L60.5,1522.8359 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#ADD8E6" height="31.6094" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="105" x="156" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="163" y="71.5332">UserController</text><rect fill="#ADD8E6" height="31.6094" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="105" x="156" y="1446.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="163" y="1468.2598">UserController</text><rect fill="#ADD8E6" height="31.6094" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="99" x="417" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="85" x="424" y="71.5332">UserManager</text><rect fill="#ADD8E6" height="31.6094" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="99" x="417" y="1446.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="85" x="424" y="1468.2598">UserManager</text><rect fill="#ADD8E6" height="31.6094" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="96" x="719.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="82" x="726.5" y="71.5332">UserProvider</text><rect fill="#ADD8E6" height="31.6094" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="96" x="719.5" y="1446.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="82" x="726.5" y="1468.2598">UserProvider</text><rect fill="#ADD8E6" height="31.6094" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="110" x="825.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="96" x="832.5" y="71.5332">TokenManager</text><rect fill="#ADD8E6" height="31.6094" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="110" x="825.5" y="1446.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="96" x="832.5" y="1468.2598">TokenManager</text><rect fill="#ADD8E6" height="31.6094" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="153" x="945.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="139" x="952.5" y="71.5332">UserLocationManager</text><rect fill="#ADD8E6" height="31.6094" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="153" x="945.5" y="1446.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="139" x="952.5" y="1468.2598">UserLocationManager</text><rect fill="#ADD8E6" height="31.6094" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="65" x="1108.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="51" x="1115.5" y="71.5332">Security</text><rect fill="#ADD8E6" height="31.6094" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="65" x="1108.5" y="1446.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="51" x="1115.5" y="1468.2598">Security</text><rect fill="#ADD8E6" height="31.6094" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="118" x="1183.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="104" x="1190.5" y="71.5332">MessageService</text><rect fill="#ADD8E6" height="31.6094" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="118" x="1183.5" y="1446.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="104" x="1190.5" y="1468.2598">MessageService</text><polygon fill="#FF4500" points="196.5,110.9609,206.5,114.9609,196.5,118.9609,200.5,114.9609" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;" x1="47.5" x2="202.5" y1="114.9609" y2="114.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="54.5" y="110.1045">Login (email, password)</text><polygon fill="#FF4500" points="454.5,141.3125,464.5,145.3125,454.5,149.3125,458.5,145.3125" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;" x1="208.5" x2="460.5" y1="145.3125" y2="145.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="215.5" y="140.4561">Login (email, password)</text><polygon fill="#FF4500" points="1010,171.6641,1020,175.6641,1010,179.6641,1014,175.6641" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;" x1="466.5" x2="1016" y1="175.6641" y2="175.6641"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="185" x="473.5" y="170.8076">Check if ip is blocked (ipadress)</text><polygon fill="#FF4500" points="477.5,202.0156,467.5,206.0156,477.5,210.0156,473.5,206.0156" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="471.5" x2="1021" y1="206.0156" y2="206.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="483.5" y="201.1592">Returns whether ip is block</text><path d="M20,221.0156 L81,221.0156 L81,229.3672 L71,239.3672 L20,239.3672 L20,221.0156 " fill="#EEEEEE" style="stroke:#FF0000;stroke-width:1.5;"/><rect fill="none" height="79.0547" style="stroke:#FF0000;stroke-width:1.0;" width="506" x="20" y="221.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="16" x="35" y="235.5107">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="65" x="96" y="234.4346">[Ip blocked]</text><polygon fill="#FF4500" points="219.5,257.7188,209.5,261.7188,219.5,265.7188,215.5,261.7188" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="213.5" x2="465.5" y1="261.7188" y2="261.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="155" x="225.5" y="256.8623">Throw IpBlocked exception</text><polygon fill="#FF4500" points="58.5,288.0703,48.5,292.0703,58.5,296.0703,54.5,292.0703" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="52.5" x2="207.5" y1="292.0703" y2="292.0703"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134" x="64.5" y="287.2139">Return status forbidden</text><polygon fill="#FF4500" points="755.5,325.4219,765.5,329.4219,755.5,333.4219,759.5,329.4219" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;" x1="466.5" x2="761.5" y1="329.4219" y2="329.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="473.5" y="324.5654">Get user by email(email)</text><polygon fill="#FF4500" points="477.5,355.7734,467.5,359.7734,477.5,363.7734,473.5,359.7734" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;" x1="471.5" x2="766.5" y1="359.7734" y2="359.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="69" x="483.5" y="354.917">Return User</text><path d="M20,374.7734 L81,374.7734 L81,383.125 L71,393.125 L20,393.125 L20,374.7734 " fill="#EEEEEE" style="stroke:#FF0000;stroke-width:1.5;"/><rect fill="none" height="79.0547" style="stroke:#FF0000;stroke-width:1.0;" width="506" x="20" y="374.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="16" x="35" y="389.2686">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="90" x="96" y="388.1924">[User not found]</text><polygon fill="#FF4500" points="219.5,411.4766,209.5,415.4766,219.5,419.4766,215.5,415.4766" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="213.5" x2="465.5" y1="415.4766" y2="415.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="65" x="225.5" y="410.6201">Login failed</text><polygon fill="#FF4500" points="58.5,441.8281,48.5,445.8281,58.5,449.8281,54.5,445.8281" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="52.5" x2="207.5" y1="445.8281" y2="445.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="65" x="64.5" y="440.9717">Login failed</text><path d="M20,467.8281 L81,467.8281 L81,476.1797 L71,486.1797 L20,486.1797 L20,467.8281 " fill="#EEEEEE" style="stroke:#FF0000;stroke-width:1.5;"/><rect fill="none" height="79.0547" style="stroke:#FF0000;stroke-width:1.0;" width="506" x="20" y="467.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="16" x="35" y="482.3232">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="87" x="96" y="481.2471">[User is locked]</text><polygon fill="#FF4500" points="219.5,504.5313,209.5,508.5313,219.5,512.5313,215.5,508.5313" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="213.5" x2="465.5" y1="508.5313" y2="508.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="225.5" y="503.6748">Throw account locked exception</text><polygon fill="#FF4500" points="58.5,534.8828,48.5,538.8828,58.5,542.8828,54.5,538.8828" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="52.5" x2="207.5" y1="538.8828" y2="538.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134" x="64.5" y="534.0264">Return status forbidden</text><path d="M20,560.8828 L81,560.8828 L81,569.2344 L71,579.2344 L20,579.2344 L20,560.8828 " fill="#EEEEEE" style="stroke:#FF0000;stroke-width:1.5;"/><rect fill="none" height="79.0547" style="stroke:#FF0000;stroke-width:1.0;" width="506" x="20" y="560.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="16" x="35" y="575.3779">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="113" x="96" y="574.3018">[User is not verified]</text><polygon fill="#FF4500" points="219.5,597.5859,209.5,601.5859,219.5,605.5859,215.5,601.5859" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="213.5" x2="465.5" y1="601.5859" y2="601.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="230" x="225.5" y="596.7295">throw Account Is Not Verified Exception</text><polygon fill="#FF4500" points="58.5,627.9375,48.5,631.9375,58.5,635.9375,54.5,631.9375" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="52.5" x2="207.5" y1="631.9375" y2="631.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134" x="64.5" y="627.0811">Return status forbidden</text><polygon fill="#FF4500" points="1129,665.2891,1139,669.2891,1129,673.2891,1133,669.2891" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;" x1="466.5" x2="1135" y1="669.2891" y2="669.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="185" x="473.5" y="664.4326">Hash password (password, salt)</text><line style="stroke:#FF4500;stroke-width:1.0;" x1="466.5" x2="508.5" y1="699.6406" y2="699.6406"/><line style="stroke:#FF4500;stroke-width:1.0;" x1="508.5" x2="508.5" y1="699.6406" y2="712.6406"/><line style="stroke:#FF4500;stroke-width:1.0;" x1="467.5" x2="508.5" y1="712.6406" y2="712.6406"/><polygon fill="#FF4500" points="477.5,708.6406,467.5,712.6406,477.5,716.6406,473.5,712.6406" style="stroke:#FF4500;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="287" x="473.5" y="694.7842">Check if salted password matches user password</text><path d="M20,727.6406 L81,727.6406 L81,735.9922 L71,745.9922 L20,745.9922 L20,727.6406 " fill="#EEEEEE" style="stroke:#FF0000;stroke-width:1.5;"/><rect fill="none" height="79.0547" style="stroke:#FF0000;stroke-width:1.0;" width="506" x="20" y="727.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="16" x="35" y="742.1357">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="153" x="96" y="741.0596">[Password does not match]</text><polygon fill="#FF4500" points="219.5,764.3438,209.5,768.3438,219.5,772.3438,215.5,768.3438" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="213.5" x2="465.5" y1="768.3438" y2="768.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="65" x="225.5" y="763.4873">Login failed</text><polygon fill="#FF4500" points="58.5,794.6953,48.5,798.6953,58.5,802.6953,54.5,798.6953" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="52.5" x2="207.5" y1="798.6953" y2="798.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="65" x="64.5" y="793.8389">Login failed</text><polygon fill="#FF4500" points="1010,832.0469,1020,836.0469,1010,840.0469,1014,836.0469" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;" x1="466.5" x2="1016" y1="836.0469" y2="836.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="297" x="473.5" y="831.1904">Check if user has been logged in from ip (ip, userid)</text><polygon fill="#FF4500" points="477.5,862.3984,467.5,866.3984,477.5,870.3984,473.5,866.3984" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="471.5" x2="1021" y1="866.3984" y2="866.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="279" x="483.5" y="861.542">Returns whether user has been logged in from ip</text><path d="M10,881.3984 L71,881.3984 L71,889.75 L61,899.75 L10,899.75 L10,881.3984 " fill="#EEEEEE" style="stroke:#FF0000;stroke-width:1.5;"/><rect fill="none" height="427.9219" style="stroke:#FF0000;stroke-width:1.0;" width="1301.5" x="10" y="881.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="16" x="25" y="895.8936">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="250" x="86" y="894.8174">[Has not been logged in from location before]</text><polygon fill="#FF4500" points="1230.5,918.1016,1240.5,922.1016,1230.5,926.1016,1234.5,922.1016" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;" x1="466.5" x2="1236.5" y1="922.1016" y2="922.1016"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="264" x="473.5" y="917.2451">Send mail with verification code to user(email)</text><polygon fill="#FF4500" points="219.5,948.4531,209.5,952.4531,219.5,956.4531,215.5,952.4531" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="213.5" x2="465.5" y1="952.4531" y2="952.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177" x="225.5" y="947.5967">Throw Required 2FA exception</text><polygon fill="#FF4500" points="58.5,978.8047,48.5,982.8047,58.5,986.8047,54.5,982.8047" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="52.5" x2="207.5" y1="982.8047" y2="982.8047"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134" x="64.5" y="977.9482">Return status forbidden</text><polygon fill="#FF4500" points="196.5,1009.1563,206.5,1013.1563,196.5,1017.1563,200.5,1013.1563" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;" x1="47.5" x2="202.5" y1="1013.1563" y2="1013.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134" x="54.5" y="1008.2998">Enters verification code</text><polygon fill="#FF4500" points="454.5,1039.5078,464.5,1043.5078,454.5,1047.5078,458.5,1043.5078" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;" x1="208.5" x2="460.5" y1="1043.5078" y2="1043.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="234" x="215.5" y="1038.6514">VerificationLogin(email, verification code)</text><line style="stroke:#FF4500;stroke-width:1.0;" x1="466.5" x2="508.5" y1="1073.8594" y2="1073.8594"/><line style="stroke:#FF4500;stroke-width:1.0;" x1="508.5" x2="508.5" y1="1073.8594" y2="1086.8594"/><line style="stroke:#FF4500;stroke-width:1.0;" x1="467.5" x2="508.5" y1="1086.8594" y2="1086.8594"/><polygon fill="#FF4500" points="477.5,1082.8594,467.5,1086.8594,477.5,1090.8594,473.5,1086.8594" style="stroke:#FF4500;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165" x="473.5" y="1069.0029">Check if verification matches</text><path d="M20,1101.8594 L81,1101.8594 L81,1110.2109 L71,1120.2109 L20,1120.2109 L20,1101.8594 " fill="#EEEEEE" style="stroke:#FF0000;stroke-width:1.5;"/><rect fill="none" height="79.0547" style="stroke:#FF0000;stroke-width:1.0;" width="506" x="20" y="1101.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="16" x="35" y="1116.3545">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="160" x="96" y="1115.2783">[Verification does not match]</text><polygon fill="#FF4500" points="219.5,1138.5625,209.5,1142.5625,219.5,1146.5625,215.5,1142.5625" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="213.5" x2="465.5" y1="1142.5625" y2="1142.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="65" x="225.5" y="1137.7061">Login failed</text><polygon fill="#FF4500" points="58.5,1168.9141,48.5,1172.9141,58.5,1176.9141,54.5,1172.9141" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="52.5" x2="207.5" y1="1172.9141" y2="1172.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="65" x="64.5" y="1168.0576">Login failed</text><polygon fill="#FF4500" points="219.5,1206.2656,209.5,1210.2656,219.5,1214.2656,215.5,1210.2656" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="213.5" x2="465.5" y1="1210.2656" y2="1210.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="76" x="225.5" y="1205.4092">Returns User</text><polygon fill="#FF4500" points="868.5,1236.6172,878.5,1240.6172,868.5,1244.6172,872.5,1240.6172" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;" x1="208.5" x2="874.5" y1="1240.6172" y2="1240.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143" x="215.5" y="1235.7607">Get token for user (User)</text><polygon fill="#FF4500" points="219.5,1266.9688,209.5,1270.9688,219.5,1274.9688,215.5,1270.9688" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="213.5" x2="879.5" y1="1270.9688" y2="1270.9688"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="225.5" y="1266.1123">Returns Token</text><polygon fill="#FF4500" points="58.5,1297.3203,48.5,1301.3203,58.5,1305.3203,54.5,1301.3203" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="52.5" x2="207.5" y1="1301.3203" y2="1301.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="74" x="64.5" y="1296.4639">Return token</text><polygon fill="#FF4500" points="219.5,1334.6719,209.5,1338.6719,219.5,1342.6719,215.5,1338.6719" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="213.5" x2="465.5" y1="1338.6719" y2="1338.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="76" x="225.5" y="1333.8154">Returns User</text><polygon fill="#FF4500" points="868.5,1365.0234,878.5,1369.0234,868.5,1373.0234,872.5,1369.0234" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;" x1="208.5" x2="874.5" y1="1369.0234" y2="1369.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143" x="215.5" y="1364.167">Get token for user (User)</text><polygon fill="#FF4500" points="219.5,1395.375,209.5,1399.375,219.5,1403.375,215.5,1399.375" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="213.5" x2="879.5" y1="1399.375" y2="1399.375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="225.5" y="1394.5186">Returns Token</text><polygon fill="#FF4500" points="58.5,1425.7266,48.5,1429.7266,58.5,1433.7266,54.5,1429.7266" style="stroke:#FF4500;stroke-width:1.0;"/><line style="stroke:#FF4500;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="52.5" x2="207.5" y1="1429.7266" y2="1429.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="74" x="64.5" y="1424.8701">Return token</text><!--MD5=[051f08522b056a43e435f275f0b982a2]
@startuml Login SD

skinparam sequence {
    GroupBorderColor red
    GroupBorderThickness 1

    ArrowColor orangered

    LifeLineBorderColor blue

    ParticipantBackgroundColor lightblue
}

actor User
participant UserController
participant UserManager
participant UserProvider
participant TokenManager
participant UserLocationManager
participant Security

User->UserController: Login (email, password)
UserController->UserManager: Login (email, password)
UserManager->UserLocationManager: Check if ip is blocked (ipadress)
UserLocationManager- ->UserManager: Returns whether ip is block

alt Ip blocked
UserManager- ->UserController: Throw IpBlocked exception
UserController- ->User: Return status forbidden
end

UserManager->UserProvider: Get user by email(email)
UserProvider->UserManager: Return User


alt User not found

UserManager- ->UserController: Login failed
UserController- ->User: Login failed

end

alt User is locked

UserManager- ->UserController: Throw account locked exception
UserController- ->User: Return status forbidden

end

alt User is not verified

UserManager- ->UserController: throw Account Is Not Verified Exception
UserController- ->User: Return status forbidden

end

UserManager->Security: Hash password (password, salt)
UserManager->UserManager: Check if salted password matches user password

alt Password does not match

UserManager- ->UserController: Login failed
UserController- ->User: Login failed

end


UserManager->UserLocationManager: Check if user has been logged in from ip (ip, userid)
UserLocationManager- ->UserManager: Returns whether user has been logged in from ip

alt Has not been logged in from location before

UserManager->MessageService: Send mail with verification code to user(email)
UserManager- ->UserController: Throw Required 2FA exception
UserController- ->User: Return status forbidden
User->UserController: Enters verification code
UserController->UserManager: VerificationLogin(email, verification code)
UserManager->UserManager: Check if verification matches
alt Verification does not match

UserManager- ->UserController: Login failed
UserController- ->User: Login failed

end
UserManager- ->UserController: Returns User
UserController->TokenManager: Get token for user (User)
TokenManager- ->UserController: Returns Token
UserController- ->User: Return token
end

UserManager- ->UserController: Returns User
UserController->TokenManager: Get token for user (User)
TokenManager- ->UserController: Returns Token

UserController- ->User: Return token

@enduml

PlantUML version 1.2022.7(Mon Aug 22 19:01:30 CEST 2022)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: Cp1252
Language: da
Country: DK
--></g></svg>